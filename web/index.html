<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EOSBF 2025 | Sessões</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

  <style>
    code {
      background-color: #ededed;
      border-radius: 6px;
      padding: 2px 6px;
    }
  </style>
</head>

<body class="bg-gray-50 p-6 font-sans pb-20">
  <!-- Fixed Top Buttons -->
  <div class="fixed top-0 left-0 right-0 bg-white shadow-md p-3 z-10 flex justify-between items-center">
    <h1 class="text-xl font-bold text-gray-800">EOSBF 2025 | Escolha de Sessões</h1>
    <div class="flex space-x-3 items-center justify-center">
      <a href="https://www.eventweb.com.br/eosbf2025/home-event/schedule.php?q=&area=todas&sessao=todas&tipo=1#trabalhos"
        target="_blank" class="cursor-pointer">Lista
        oficial de trabalhos</a>
      <button id="shareUrlBtn"
        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md font-medium transition-colors duration-200 flex items-center cursor-pointer"
        onclick="shareSelections()">
        🔗 Compartilhar
      </button>
      <button id="viewSummaryBtn"
        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md font-medium transition-colors duration-200 flex items-center cursor-pointer opacity-50 pointer-events-none">
        📋 Ver Resumo
      </button>
      <button id="clearAllBtn"
        class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md font-medium transition-colors duration-200 flex items-center cursor-pointer opacity-50 pointer-events-none">
        &cross; Limpar escolhas
      </button>
    </div>
  </div>

  <div class="max-w-[1800px] mx-auto bg-white rounded-lg shadow-sm p-6 mt-16">
    <!-- Sessions Groups Container -->
    <div id="sessionsContainer"></div>
  </div>

  <script>
    let sessions = [];

    // Close any open modal when pressing Escape
    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") {
        document.getElementById('presentationsModal')?.remove();
        document.getElementById('summaryModal')?.remove();
      }
    }, false);

    // Update button states
    function updateButtons() {
      const clearButton = document.getElementById('clearAllBtn');
      const summaryButton = document.getElementById('viewSummaryBtn');
      const selectedSessions = getSelectedSessions();
      const hasSelections = Object.keys(selectedSessions).length > 0;

      if (hasSelections) {
        clearButton.classList.remove('opacity-50', 'pointer-events-none');
        summaryButton.classList.remove('opacity-50', 'pointer-events-none');
      } else {
        clearButton.classList.add('opacity-50', 'pointer-events-none');
        summaryButton.classList.add('opacity-50', 'pointer-events-none');
      }
    }

    // Group sessions by date and time
    function groupSessionsByDateTime() {
      const groups = {};

      sessions.forEach(session => {
        const key = `${session.date}-${session.time}`;
        if (!groups[key]) {
          groups[key] = {
            date: session.date,
            time: session.time,
            sessions: []
          };
        }
        groups[key].sessions.push(session);
      });

      // Sort groups by date and time
      return Object.values(groups).sort((a, b) => {
        // First compare dates
        const dateComparison = a.date.localeCompare(b.date);
        if (dateComparison !== 0) return dateComparison;
        
        // If dates are equal, compare times
        return a.time.localeCompare(b.time);
      });
    }

    // Display sessions grouped by date and time
    function displaySessions() {
      const container = document.getElementById('sessionsContainer');
      container.innerHTML = '';

      const groups = groupSessionsByDateTime();
      const selectedSessions = getSelectedSessions();

      groups.forEach(group => {
        const dateFormatted = formatDate(group.date);
        const groupElement = document.createElement('div');
        groupElement.className = 'mb-8 pb-6 border-b border-gray-300';

        const groupHeader = document.createElement('h2');
        groupHeader.className = 'text-2xl font-semibold mb-3 text-gray-700';
        groupHeader.innerHTML = `${dateFormatted} ${group.time}`;
        groupElement.appendChild(groupHeader);

        const alreadySelected = group.sessions.some(session =>
          selectedSessions[`${session.date}-${session.time}`]);

        if (alreadySelected) {
          const selectedSessionKey = `${group.date}-${group.time}`;
          const selectedSessionId = selectedSessions[selectedSessionKey];
          const selectedSession = group.sessions.find(s => s.session === selectedSessionId);

          const selectionInfo = document.createElement('div');
          selectionInfo.className = 'p-4 bg-blue-50 border border-blue-200 rounded-lg mb-3 relative';
          selectionInfo.innerHTML = `
                        <div class="absolute top-2 right-2">
                            <button class="text-red-500 hover:text-red-700 cursor-pointer text-2xl" 
                                    data-key="${group.date}-${group.time}"
                                    onclick="removeSession('${group.date}-${group.time}')">
                                &cross;
                            </button>
                        </div>
                        <div class="flex items-center mb-2">
                            <span class="bg-green-200 text-green-800 text-xs font-medium px-2 py-1 rounded">&#9989; Selecionada</span>
                        </div>
                        <p class="font-medium text-lg">${selectedSession.session}</p>
                        <p class="text-sm text-gray-600">${selectedSession.location}</p>
                        <p class="text-sm text-gray-600">${selectedSession.presentations.length} ${selectedSession.presentations.length > 1 ? "apresentações" : "apresentação"}</p>
                        <div class="mt-3 flex space-x-3">
                            <button class="text-sm text-blue-600 hover:text-blue-800 flex items-center cursor-pointer"
                                    onclick="showPresentations('${selectedSession.session}')">
                                Ver Apresentações
                            </button>
                            <button class="text-sm text-blue-600 hover:text-blue-800 flex items-center cursor-pointer"
                                    onclick="toggleSessionOptions('${group.date}-${group.time}')">
                                Trocar Seleção
                            </button>
                            <a href="${createGoogleCalendarLink(group.date, group.time, selectedSession.session, selectedSession.location)}" 
                               target="_blank"
                               class="text-sm text-green-600 hover:text-green-800 flex items-center cursor-pointer">
                               📅 Adicionar ao Calendário
                            </a>
                        </div>
                    `;
          groupElement.appendChild(selectionInfo);

          // Add hidden session options that will be shown when "Trocar Seleção" is clicked
          const sessionsContainer = document.createElement('div');
          sessionsContainer.className = 'hidden session-options grid grid-cols-1 md:grid-cols-3 gap-4';
          sessionsContainer.id = `session-options-${group.date}-${group.time}`;

          group.sessions.forEach(session => {
            const sessionCard = createSessionCard(session, group.date, group.time);
            sessionsContainer.appendChild(sessionCard);
          });

          groupElement.appendChild(sessionsContainer);
        } else {
          // Show all sessions in this group for selection
          const sessionsContainer = document.createElement('div');
          sessionsContainer.className = 'grid grid-cols-1 md:grid-cols-3 gap-4';

          group.sessions.forEach(session => {
            const sessionCard = createSessionCard(session, group.date, group.time);
            sessionsContainer.appendChild(sessionCard);
          });

          groupElement.appendChild(sessionsContainer);
        }

        container.appendChild(groupElement);
      });
    }

    // Toggle session options visibility
    function toggleSessionOptions(key) {
      const optionsContainer = document.getElementById(`session-options-${key}`);
      if (optionsContainer) {
        optionsContainer.classList.toggle('hidden');
        // Also hide the selection info when showing options
        const selectionInfo = optionsContainer.previousElementSibling;
        if (!optionsContainer.classList.contains('hidden')) {
          selectionInfo.classList.add('hidden');
        } else {
          selectionInfo.classList.remove('hidden');
        }
      }
    }

    // Create a card for a session
    function createSessionCard(session, date, time) {
      const card = document.createElement('div');
      card.className = 'border border-gray-300 p-4 rounded-lg shadow-sm hover:shadow transition-shadow duration-200 bg-white';

      // Calculate total presentations
      const presentationsCount = session.presentations.length;

      // Get unique fields from presentations
      const fields = [...new Set(session.presentations.map(p => p.field))];

      // Limit fields to 3 for display
      const displayFields = fields.length > 3
        ? fields.slice(0, 3).join(', ') + ` +${fields.length - 3}`
        : fields.join(', ');

      card.innerHTML = `
                <h3 class="font-medium text-lg mb-2 text-gray-800">${session.session}</h3>
                <div class="space-y-1 mb-3">
                    <p class="text-sm text-gray-600">${session.location}</p>
                    <p class="text-sm text-gray-600">${presentationsCount} ${presentationsCount > 1 ? "apresentações" : "apresentação"}</p>
                    <p class="text-sm text-gray-600">${displayFields}</p>
                </div>
                <div class="mt-3 flex space-x-2">
                    <button class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200 flex items-center cursor-pointer"
                            onclick="selectSession({session: '${session.session}', date: '${date}', time: '${time}', location: '${session.location}'})">
                        Selecionar
                    </button>
                    <button class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200 flex items-center cursor-pointer"
                            onclick="showPresentations('${session.session}')">
                        Ver Apresentações
                    </button>
                </div>
            `;

      return card;
    }

    // Select a session
    function selectSession(sessionData) {
      const { session, date, time } = sessionData;
      const key = `${date}-${time}`;

      // Get current selections from URL
      let selectedSessions = getSelectedSessions();

      // Update selection
      selectedSessions[key] = session;

      // Save to URL
      updateUrlWithSelections(selectedSessions);

      // Refresh the display
      displaySessions();
      updateButtons();
    }

    // Update URL with selected sessions using compact format
    function updateUrlWithSelections(selectedSessions) {
      const newUrl = new URL(window.location.href);
      
      if (Object.keys(selectedSessions).length > 0) {
        // Create a compact array of session IDs for the URL
        const sessionIds = [];
        
        // For each date-time key, get the session ID
        Object.entries(selectedSessions).forEach(([key, sessionName]) => {
          // Find the session object to get a unique identifier
          const session = sessions.find(s => s.session === sessionName);
          if (session) {
            // Create a compact ID using the session name and date-time
            const sessionId = createSessionId(session, key);
            sessionIds.push(sessionId);
          }
        });
        
        if (sessionIds.length > 0) {
          newUrl.searchParams.set('s', sessionIds.join('-'));
        } else {
          newUrl.searchParams.delete('s');
        }
      } else {
        newUrl.searchParams.delete('s');
      }
      
      // Update URL without reloading the page
      window.history.pushState({}, '', newUrl);
    }
    
    // Create a unique but short ID for a session
    function createSessionId(session, dateTimeKey) {
      // Extract date and time from the key
      const [date, time] = dateTimeKey.split('-');
      
      console.log(`Creating ID for session: "${session.session}" with date: ${date}, time: ${time}`);
      
      // Process the date to a simpler format (MMDD)
      const dateSimple = date.replace(/\//g, '').substring(4); // Remove slashes and get only month and day
      
      // Process the time to a simpler format (HHMM)
      // Extract only the start time and remove any non-digit characters
      const timeStart = time.split('-')[0]; // Get only start time
      const timeSimple = timeStart.replace(/\D/g, ''); // Remove all non-digits
      
      // Pad to ensure we have 4 digits
      const timeSimplePadded = timeSimple.padStart(4, '0').substring(0, 4);
      
      // Create a hash of the session name (use only first 4 chars for compactness)
      const sessionHash = hashString(session.session).substring(0, 4);
      
      // Combine them all
      const sessionId = `${dateSimple}${timeSimplePadded}${sessionHash}`;
      console.log(`Generated session ID: ${sessionId} from date: ${dateSimple}, time: ${timeSimplePadded}, hash: ${sessionHash}`);
      
      return sessionId;
    }
    
    // Get selected sessions from URL using compact format
    function getSelectedSessions() {
      const urlParams = new URLSearchParams(window.location.search);
      const sessionsParam = urlParams.get('s');
      
      if (!sessionsParam) {
        return {};
      }
      
      const selectedSessions = {};
      const sessionIds = sessionsParam.split('-');
      
      console.log('Loading sessions from URL:', sessionIds);
      
      // Loop through all session IDs in the URL
      sessionIds.forEach(sessionId => {
        // Parse the session ID to extract date and time
        const dateTime = parseSessionId(sessionId);
        
        if (dateTime) {
          console.log(`Parsed dateTime from ID ${sessionId}:`, dateTime);
          
          // Find matching session
          const matchedSession = findSessionByIdAndDateTime(sessionId, dateTime);
          if (matchedSession) {
            console.log(`Found matching session:`, matchedSession.session);
            selectedSessions[dateTime] = matchedSession.session;
          } else {
            console.warn(`No matching session found for dateTime: ${dateTime}`);
          }
        } else {
          console.warn(`Could not parse dateTime from ID: ${sessionId}`);
        }
      });
      
      console.log('Final selected sessions:', selectedSessions);
      return selectedSessions;
    }
    
    // Parse a session ID back to its date-time key
    function parseSessionId(sessionId) {
      if (sessionId.length >= 8) { // Ensure we have enough characters
        // Extract date part (MMDD)
        const month = sessionId.substring(0, 2);
        const day = sessionId.substring(2, 4);
        
        // Extract time part (HHMM)
        const hour = sessionId.substring(4, 6);
        const minute = sessionId.substring(6, 8);
        
        console.log(`Parsing session ID ${sessionId}: month=${month}, day=${day}, hour=${hour}, minute=${minute}`);
        
        // Reconstruct the date-time key
        const eventYear = 2025; // Hard-coded for this specific event
        
        // Create the basic date-time without specific formatting yet
        const dateKey = `${eventYear}/${month}/${day}`;
        const baseTimeKey = `${hour}${minute}`; // Just digits
        
        console.log(`Base date-time: ${dateKey}-${baseTimeKey}`);
        
        // Look for matching sessions to determine the right format
        const matchingSessions = sessions.filter(s => s.date === dateKey);
        
        if (matchingSessions.length > 0) {
          console.log(`Found ${matchingSessions.length} sessions on date ${dateKey}`);
          
          // Try to find a session with matching time (start time only)
          for (const session of matchingSessions) {
            // Extract just the digits from the start time for comparison
            const sessionTimeStart = session.time.split('-')[0];
            const sessionTimeDigits = sessionTimeStart.replace(/\D/g, '');
            
            console.log(`Comparing ${baseTimeKey} with ${sessionTimeDigits} from ${session.time}`);
            
            // If we find a matching time, use that session's time format
            if (sessionTimeDigits === baseTimeKey || 
                // Handle special cases where padding might differ
                (sessionTimeDigits.length >= 3 && baseTimeKey.endsWith(sessionTimeDigits)) ||
                (baseTimeKey.length >= 3 && sessionTimeDigits.endsWith(baseTimeKey))) {
              
              console.log(`Found matching session with time ${session.time}`);
              return `${dateKey}-${session.time}`;
            }
          }
          
          // If no exact match found, use the first session's time format as template
          const templateSession = matchingSessions[0];
          const timeFormat = templateSession.time;
          
          // Check if time format uses h or : and reconstruct accordingly
          let reconstructedTime;
          if (timeFormat.includes('h')) {
            reconstructedTime = `${hour}h${minute}`;
            if (timeFormat.includes('-')) {
              // If the format includes a range, try to reconstruct it
              const rangeMatch = timeFormat.match(/(\d+h\d+)-(\d+h\d+)/);
              if (rangeMatch) {
                const timeRange = rangeMatch[2]; // End time
                reconstructedTime += `-${timeRange}`;
              }
            }
          } else if (timeFormat.includes(':')) {
            reconstructedTime = `${hour}:${minute}`;
            if (timeFormat.includes('-')) {
              // If the format includes a range, try to reconstruct it
              const rangeMatch = timeFormat.match(/(\d+:\d+)-(\d+:\d+)/);
              if (rangeMatch) {
                const timeRange = rangeMatch[2]; // End time
                reconstructedTime += `-${timeRange}`;
              }
            }
          } else {
            // Unknown format, just use the basic format
            reconstructedTime = `${hour}h${minute}`;
          }
          
          console.log(`Reconstructed time: ${reconstructedTime}`);
          return `${dateKey}-${reconstructedTime}`;
        } else {
          // No sessions found on this date, use a basic format
          console.log(`No sessions found on date ${dateKey}, using basic format`);
          return `${dateKey}-${hour}h${minute}`;
        }
      }
      return null;
    }
    
    // Find a session by its ID and date-time
    function findSessionByIdAndDateTime(sessionId, dateTime) {
      // Extract the hash part from the session ID (characters after position 8)
      const sessionHash = sessionId.substring(8);
      
      // Get the date and time parts
      const [datePart, timePart] = dateTime.split('-');
      
      console.log(`Looking for session with date: ${datePart}, time: ${timePart}, hash: ${sessionHash}`);
      
      // Find all sessions matching this date
      const matchingSessions = sessions.filter(s => s.date === datePart);
      console.log(`Found ${matchingSessions.length} sessions for date ${datePart}`);
      
      // From these, find sessions with matching time start
      // We need to be flexible with time format
      const timeStart = timePart.split('-')[0];
      const timeMatchingSessions = matchingSessions.filter(s => {
        const sessionTimeStart = s.time.split('-')[0];
        // Normalize both times to remove h/: for comparison
        const normalizedTimeStart = timeStart.replace(/[h:]/g, '');
        const normalizedSessionTimeStart = sessionTimeStart.replace(/[h:]/g, '');
        return normalizedTimeStart === normalizedSessionTimeStart;
      });
      
      console.log(`Found ${timeMatchingSessions.length} sessions matching time ${timeStart}`);
      
      // From these, find the one with the matching hash
      for (const session of timeMatchingSessions) {
        const sessionNameHash = hashString(session.session).substring(0, 4);
        console.log(`Comparing ${sessionNameHash} with ${sessionHash}`);
        if (sessionNameHash === sessionHash) {
          return session;
        }
      }
      
      // If exact hash match fails, try partial match
      for (const session of timeMatchingSessions) {
        if (hashString(session.session).includes(sessionHash)) {
          return session;
        }
      }
      
      // If we have only one session at this time slot, just return it
      if (timeMatchingSessions.length === 1) {
        console.log('Only one session at this time slot, selecting it');
        return timeMatchingSessions[0];
      }
      
      return null;
    }
    
    // Create a simple hash from a string for compact IDs
    function hashString(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32bit integer
      }
      // Convert to a base36 string for compactness
      return Math.abs(hash).toString(36);
    }

    // Extract the start time from format like "08h00-09h00" or "14h30-15h30"
    function getStartTime(timeStr) {
      const match = timeStr.match(/^(\d{2})h(\d{2})/);
      if (match) {
        return parseInt(match[1]) * 60 + parseInt(match[2]); // Convert to minutes for comparison
      }
      return 0;
    }

    // Show summary of selected sessions
    function showSessionsSummary() {
      const selectedSessions = getSelectedSessions();
      if (Object.keys(selectedSessions).length === 0) return;

      // Create array of selected session details
      let selectedSessionsDetails = [];
      Object.keys(selectedSessions).forEach(key => {
        const [date, time] = key.split('-');
        const sessionName = selectedSessions[key];
        const session = getSessionByName(sessionName);
        if (session) {
          selectedSessionsDetails.push({
            date,
            time,
            session: sessionName,
            location: session.location,
            presentations: session.presentations.length
          });
        }
      });

      // Sort by date and time
      selectedSessionsDetails.sort((a, b) => {
        if (a.date !== b.date) return a.date.localeCompare(b.date);
        return a.time.localeCompare(b.time);
      });

      // Create modal for summary
      const summaryModal = document.createElement('div');
      summaryModal.classList = "fixed top-0 left-0 right-0 w-full h-screen bg-black/75 flex items-center justify-center z-30 p-6";
      summaryModal.id = 'summaryModal';

      let sessionsList = '';
      selectedSessionsDetails.forEach(details => {
        // Get the session to access presentation details
        const session = getSessionByName(details.session);

        // Create list of presentations with links to abstracts
        let presentationsList = '';
        if (session && session.presentations) {
          // Sort presentations by hour
          const sortedPresentations = [...session.presentations].sort((a, b) => {
            return getStartTime(a.hour) - getStartTime(b.hour);
          });
          
          presentationsList = `
            <div class="mt-3 border-t border-gray-200 pt-3">
              <p class="text-sm font-medium text-gray-700 mb-2">Apresentações:</p>
              <ul class="text-sm space-y-1 pl-4">
                ${sortedPresentations.map(pres => `
                  <li>
                    <a href="${pres.abstract}" target="_blank" class="text-blue-600 hover:text-blue-800 cursor-pointer">
                      ${pres.hour}: ${pres.title}
                    </a>
                  </li>
                `).join('')}
              </ul>
            </div>
          `;
        }

        sessionsList += `
          <div class="border border-gray-300 p-4 rounded-lg mb-4 bg-white shadow-sm">
            <div>
              <h3 class="font-bold text-lg mb-1 text-gray-800">${details.session}</h3>
              <p class="text-sm text-gray-600">
                ${formatDate(details.date)} | ${details.time} | ${details.location}
              </p>
              ${presentationsList}
            </div>
          </div>
        `;
      });

      summaryModal.innerHTML = `
        <div class="bg-white rounded-lg shadow-lg max-w-4xl w-full">
          <div class="flex justify-between items-center border-b border-gray-300 p-6">
            <div>
              <h2 class="text-2xl font-bold text-gray-800">Resumo das Sessões Selecionadas</h2>
              <p class="text-sm text-gray-600">
                Total: ${selectedSessionsDetails.length} sessões
              </p>
            </div>
            <button class="text-gray-500 hover:text-gray-700 cursor-pointer" onclick="closeSummaryModal()">
              &cross;
            </button>
          </div>
          <div class="max-h-[75vh] overflow-y-auto p-4">
            ${sessionsList}
          </div>
          <div class="border-t border-gray-300 p-4 flex justify-between">
            <div class="flex space-x-3">
              <button class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 cursor-pointer"
                      onclick="exportSelections()">
                🖨️ Imprimir Agenda
              </button>
              <button class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 cursor-pointer"
                      onclick="shareSelections()">
                🔗 Compartilhar Agenda
              </button>
            </div>
            <button class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 cursor-pointer"
                    onclick="closeSummaryModal()">
              Fechar
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(summaryModal);

      // Close modal when clicking outside
      summaryModal.onclick = function (e) {
        if (e.target === summaryModal) {
          closeSummaryModal();
        }
      };
    }

    // Export selections as printable HTML page
    function exportSelections() {
      const selectedSessions = getSelectedSessions();
      if (Object.keys(selectedSessions).length === 0) return;

      // Create array of selected session details
      let selectedSessionsDetails = [];
      Object.keys(selectedSessions).forEach(key => {
        const [date, time] = key.split('-');
        const sessionName = selectedSessions[key];
        const session = getSessionByName(sessionName);
        if (session) {
          // Sort presentations by hour before adding to the details
          const sortedPresentations = [...session.presentations].sort((a, b) => {
            return getStartTime(a.hour) - getStartTime(b.hour);
          });
          
          selectedSessionsDetails.push({
            date,
            time,
            session: sessionName,
            location: session.location,
            presentations: sortedPresentations
          });
        }
      });

      // Sort by date and time
      selectedSessionsDetails.sort((a, b) => {
        if (a.date !== b.date) return a.date.localeCompare(b.date);
        return a.time.localeCompare(b.time);
      });

      // Build HTML for the print page with Tailwind CSS
      let printHTML = `
    <!DOCTYPE html>
    <html lang="pt-BR">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Minha Agenda EOSBF 2025</title>
      <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"><\/script>
      <style>
        @media print {
          .no-print {
            display: none;
          }
          @page {
            size: A4;
            margin: 1cm;
          }
          body {
            print-color-adjust: exact;
            -webkit-print-color-adjust: exact;
          }
        }
      </style>
    </head>
    <body class="bg-gray-50 text-gray-800 font-sans leading-relaxed">
      <div class="max-w-4xl mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-900">Minha Agenda EOSBF 2025</h1>
  `;

      selectedSessionsDetails.forEach((details, index) => {
        printHTML += `
      <div class="mb-10 bg-white rounded-xl overflow-hidden p-6 break-inside-avoid border border-gray-200">
        <div class="border-b border-gray-200 pb-4 mb-4">
          <h2 class="text-2xl font-bold text-gray-800">${formatDate(details.date)} - ${details.time}</h2>
          <h2 class="text-gray-700">${details.session}</h2>
          <p class="text-gray-600">${details.location}</p>
        </div>
        
        <div class="space-y-2">
          <h3 class="text-xl font-semibold text-gray-800 mb-3">Apresentações:</h3>
    `;

        details.presentations.forEach(pres => {
          printHTML += `
            <div class="p-4 bg-blue-50 rounded-md mb-4">
              <div class="font-bold text-gray-900">
                ${pres.hour}: <a href="${pres.abstract}" target="_blank" class="text-blue-600 hover:text-blue-800 cursor-pointer">${pres.title}</a>
              </div>
         `;

          if (pres.presentedBy) {
            printHTML += `
            <div class="mt-2 text-gray-700">
              <span class="font-semibold">Apresentado por</span>: ${pres.presentedBy}<br>
              <span class="font-semibold">Universidade</span>: ${pres.authors.find((author) => author.author === pres.presentedBy)?.universities.join(", ")}<br>
            </div>
          `;
          }

          printHTML += `</div>`;
        });

        printHTML += `
        </div>
      </div>
    `;
      });

      printHTML += `
      </div>
    </body>
    </html>
  `;

      // Open the print page in a new tab
      const printWindow = window.open('', '_blank');
      printWindow.document.write(printHTML);
      printWindow.document.close();

      // Trigger print dialog after page loads
      printWindow.onload = function () {
        printWindow.focus();
        setTimeout(() => {
          printWindow.print();
        }, 500);
      };
    }

    // Clear all selections
    function clearAllSelections() {
      updateUrlWithSelections({});
      displaySessions();
      updateButtons();
    }

    // Remove a session selection
    function removeSession(key) {
      let selectedSessions = getSelectedSessions();
      delete selectedSessions[key];

      updateUrlWithSelections(selectedSessions);

      displaySessions();
      updateButtons();
    }

    // Format date from YYYY-MM-DD to more readable format
    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return capitalizeFirstLetter(date.toLocaleDateString('pt-BR', {
        weekday: 'long',
        year: undefined,
        month: 'long',
        day: 'numeric'
      }));
    }

    // Get the session by name
    function getSessionByName(sessionName) {
      return sessions.find(s => s.session === sessionName);
    }

    // Create Google Calendar link
    function createGoogleCalendarLink(date, timeStr, sessionName, location) {
      try {
        // Parse date (format: YYYY/MM/DD)
        const [year, month, day] = date.split('/').map(Number);
        
        // Parse time (format: HHh00-HHh00 or HHhMM-HHhMM)
        const timeRange = timeStr.split('-');
        const startTimeStr = timeRange[0]; // e.g., "15h00" or "15h30"
        const endTimeStr = timeRange[1] || ""; // e.g., "16h00" or "16h30"
        
        // Extract hours and minutes
        const startTimeParts = startTimeStr.split('h');
        const startHour = parseInt(startTimeParts[0], 10);
        const startMinute = startTimeParts.length > 1 ? parseInt(startTimeParts[1], 10) : 0;
        
        let endHour, endMinute;
        if (endTimeStr) {
          const endTimeParts = endTimeStr.split('h');
          endHour = parseInt(endTimeParts[0], 10);
          endMinute = endTimeParts.length > 1 ? parseInt(endTimeParts[1], 10) : 0;
        } else {
          // Default to 2 hours later if no end time
          endHour = startHour + 2;
          endMinute = startMinute;
        }
        
        // Create start and end date strings in the format YYYYMMDDTHHMMSS
        const formatDigit = (num) => num.toString().padStart(2, '0');
        
        const startDateStr = `${year}${formatDigit(month)}${formatDigit(day)}T${formatDigit(startHour)}${formatDigit(startMinute)}00`;
        const endDateStr = `${year}${formatDigit(month)}${formatDigit(day)}T${formatDigit(endHour)}${formatDigit(endMinute)}00`;
        
        // Create details string with session details
        const details = `<b>Sessão:</b> ${sessionName}\n<b>Local:</b> ${location}`;
        
        // Build the Google Calendar URL
        return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(sessionName)}&details=${encodeURIComponent(details)}&dates=${startDateStr}/${endDateStr}&ctz=America/Sao_Paulo`;
      } catch (error) {
        console.error('Error creating calendar link:', error);
        return '#'; // Return fallback link
      }
    }

    // Display presentations for a session
    function showPresentations(sessionName) {
      const session = getSessionByName(sessionName);
      if (!session) return;

      // Close summary modal if open
      closeSummaryModal();

      // Sort presentations by hour
      const sortedPresentations = [...session.presentations].sort((a, b) => {
        return getStartTime(a.hour) - getStartTime(b.hour);
      });

      // Create modal content for presentations
      const presentationsModal = document.createElement('div');
      presentationsModal.classList = "fixed top-0 left-0 right-0 w-full h-screen bg-black/75 flex items-center justify-center z-30 p-6";
      presentationsModal.id = 'presentationsModal';

      const modalWidth = sortedPresentations.length > 2 ? 'max-w-6xl' : 'max-w-2xl';

      let presentationsHTML = '';
      sortedPresentations.forEach(presentation => {
        // Get all unique universities from the authors
        const universities = presentation.authors.reduce((acc, author) => {
          author.universities.forEach(uni => {
            if (!acc.includes(uni)) acc.push(uni);
          });
          return acc;
        }, []);

        presentationsHTML += `
                <div class="border border-gray-300 p-4 rounded-lg mb-4 bg-white shadow-sm">
                    <h3 class="font-bold text-lg mb-2 text-gray-800"><a href="${presentation.abstract}" target="_blank" class="text-blue-600 hover:text-blue-800 cursor-pointer">${presentation.title}</a> &#8599;</h3>
                    <div class="flex flex-wrap gap-2 mb-3">
                        <span class="bg-blue-100 text-blue-800 text-xs text-center px-2 py-1 rounded">
                            &#127891; ${presentation.field}
                        </span>
                        <span class="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded">
                            &#128336; ${presentation.hour}
                        </span>
                    </div>
                    <div class="border-t border-gray-300 pt-2 mt-2">
                        <p class="text-sm font-medium">Apresentador: ${presentation.presentedBy}</p>
                        <div class="mt-2">
                            <p class="text-xs font-medium text-gray-500">Autores:</p>
                            <ul class="text-sm ml-4 list-disc">
                                ${presentation.authors.map(author => `
                                    <li>${author.author} 
                                        <span class="text-xs text-gray-500">(${author.universities.join(', ')})</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
                `;
      });

      presentationsModal.innerHTML = `
                <div class="bg-white rounded-lg shadow-lg ${modalWidth} w-full">
                  <div class="flex justify-between items-center border-b border-gray-300 p-6">
                      <div>
                          <h2 class="text-2xl font-bold text-gray-800">${session.session}</h2>
                          <p class="text-sm text-gray-600">
                              ${formatDate(session.date)} &nbsp;|&nbsp; ${session.time} &nbsp;|&nbsp; ${session.location}
                          </p>
                      </div>
                      <button class="text-gray-500 hover:text-gray-700 cursor-pointer" onclick="closeModal()">
                          &cross;
                      </button>
                  </div>
                  <div class="max-h-[75vh] overflow-y-auto p-4">
                    <div class="presentations-grid ${sortedPresentations.length > 2 ? 'grid grid-cols-1 md:grid-cols-3 gap-4' : 'space-y-4'}">
                      ${presentationsHTML}
                    </div>
                  </div>
                </div>
            `;

      document.body.appendChild(presentationsModal);

      // Close modal when clicking outside
      presentationsModal.onclick = function (e) {
        if (e.target === presentationsModal) {
          closeModal();
        }
      };
    }

    // Close modals functions
    function closeModal() {
      document.getElementById('presentationsModal')?.remove();
    }

    function closeSummaryModal() {
      document.getElementById('summaryModal')?.remove();
    }

    // Capitalize first letter
    function capitalizeFirstLetter(val) {
      return String(val).charAt(0).toUpperCase() + String(val).slice(1);
    }

    // Set onclick for the buttons
    document.getElementById('clearAllBtn').onclick = clearAllSelections;
    document.getElementById('viewSummaryBtn').onclick = showSessionsSummary;

    // Check for selections on load to update buttons
    window.onload = function () {
      // Load data first, then initialize UI
      Promise.all([
        fetch('oral-sessions.json').then(response => response.json()),
        fetch('invited-lectures.json').then(response => response.json()),
        fetch('intervals.json').then(response => response.json())
      ])
      .then(([oralSessionsData, invitedLecturesData, intervalsData]) => {
        // Process the data (existing code from the Promise.all callback)
        const sessionsMap = new Map();
        
        // Process oral sessions
        oralSessionsData.forEach(session => {
          sessionsMap.set(session.session, session);
        });
        
        // Process invited lectures, merging presentations if session already exists
        invitedLecturesData.forEach(session => {
          if (sessionsMap.has(session.session)) {
            // Merge presentations from both arrays
            const existingSession = sessionsMap.get(session.session);
            existingSession.presentations = [
              ...existingSession.presentations,
              ...session.presentations
            ];
          } else {
            sessionsMap.set(session.session, session);
          }
        });
        
        // Convert map back to array and add intervals
        sessions = [...sessionsMap.values(), ...intervalsData];
        
        console.log('Data loaded, checking for URL parameters');
        
        // Now check if we have URL parameters and update the UI
        try {
          if (window.location.search.includes('s=')) {
            console.log('Found session parameters in URL');
            const selectedSessions = getSelectedSessions();
            console.log('Selected sessions from URL:', selectedSessions);
            
            if (Object.keys(selectedSessions).length > 0) {
              // Force redisplay with selections
              displaySessions();
              console.log('UI updated with selections from URL');
            }
          } else {
            // No URL parameters, just display the sessions
            displaySessions();
          }
        } catch (err) {
          console.error('Error loading sessions from URL:', err);
          // Still display sessions even if there was an error
          displaySessions();
        }
        
        // Update UI states
        updateButtons();
      })
      .catch(error => {
        console.error('Error loading data:', error);
        sessionsContainer.innerHTML = "<div style='text-align: center; width: 100%;'>Erro ao carregar as sessões.<br/>Os arquivos <code>oral-sessions.json</code>, <code>invited-lectures.json</code> e <code>intervals.json</code> estão no lugar?</div>"
      });
    };

    // Share selections by copying URL to clipboard
    function shareSelections() {
      const url = window.location.href;
      
      // Try to use the modern clipboard API with fallback
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(url)
          .then(showSuccessToast)
          .catch(err => {
            console.error('Clipboard API failed:', err);
            fallbackCopyToClipboard(url);
          });
      } else {
        fallbackCopyToClipboard(url);
      }
    }
    
    // Fallback method for copying to clipboard
    function fallbackCopyToClipboard(text) {
      // Create a temporary input to copy the URL
      const tempInput = document.createElement('input');
      tempInput.value = text;
      tempInput.style.position = 'fixed';
      tempInput.style.opacity = '0';
      document.body.appendChild(tempInput);
      tempInput.select();
      
      try {
        // Copy URL to clipboard
        const success = document.execCommand('copy');
        if (success) {
          showSuccessToast();
        } else {
          throw new Error('Could not copy text');
        }
      } catch (err) {
        console.error('Fallback clipboard copy failed:', err);
        alert('Não foi possível copiar o URL. Por favor, copie manualmente da barra de endereço.');
      }
      
      // Clean up
      document.body.removeChild(tempInput);
    }
    
    // Show success toast when URL is copied
    function showSuccessToast() {
      const toast = document.createElement('div');
      toast.className = 'fixed bottom-4 right-4 bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded shadow-md z-50';
      toast.innerHTML = `
        <div class="flex items-center">
          <div class="py-1"><svg class="fill-current h-6 w-6 text-green-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M2.93 17.07A10 10 0 1 1 17.07 2.93 10 10 0 0 1 2.93 17.07zm12.73-1.41A8 8 0 1 0 4.34 4.34a8 8 0 0 0 11.32 11.32zM6.7 9.29L9 11.6l4.3-4.3 1.4 1.42L9 14.4l-3.7-3.7 1.4-1.42z"/></svg></div>
          <div>
            <p class="font-bold">URL copiada para área de transferência!</p>
            <p class="text-sm">Compartilhe com seus colegas.</p>
          </div>
        </div>
      `;
      document.body.appendChild(toast);
      
      // Remove toast after 3 seconds
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }
  </script>
</body>

</html>